require("leaflet.motion"),L.Motion.Animate.options.attribution=null,L.Motion.Event.NearPoint="motion-near-point",L.Motion.Utils.bearing=function(t,i){var n=Math.PI/180,e=t.lat*n,o=i.lat*n,a=t.lng*n,s=i.lng*n,r=Math.sin(s-a)*Math.cos(o),h=Math.cos(e)*Math.sin(o)-Math.sin(e)*Math.cos(o)*Math.cos(s-a);return(180*Math.atan2(r,h)/Math.PI+360)%360},L.Motion.Animate._motion=function(t){var i=(new Date).getTime()-t,n=1;if(this.motionOptions.duration&&(n=i/this.motionOptions.duration),n<1){n=this.motionOptions.easing(n,i,0,1,this.motionOptions.duration);var e=L.Motion.Utils.interpolateOnLine(this._map,this._linePoints,n);if(L.Polyline.prototype.addLatLng.call(this,e.latLng),this._drawMarker(e.latLng),this.motionOptions.followMarker&&!0===this.motionOptions.followMarker&&this._map.panTo(e.latLng),this.motionOptions.latLngToDetect&&this.motionOptions.latLngToDetect.length>0){var o=L.Motion.Utils.bearing(e.latLng,this.motionOptions.latLngToDetect[0].leafletCoordinate),a=this._map.distance(this.motionOptions.latLngToDetect[0].leafletCoordinate,e.latLng);if(!this.motionOptions.latLngToDetect[0].markerPassedLatLng&&null!==this.motionOptions.latLngToDetect[0].previousBearing){var s=Math.abs(o-this.motionOptions.latLngToDetect[0].previousBearing),r=s>130&&s<=340;this.motionOptions.latLngToDetect[0].markerPassedLatLng=r}if(this.motionOptions.latLngToDetect[0].markerPassedLatLng&&a<100)return this.fire(L.Motion.Event.NearPoint,{layer:this,data:this.motionOptions.latLngToDetect[0]},!1),void this.motionOptions.latLngToDetect.shift();this.motionOptions.latLngToDetect[0].previousBearing=o}this.__ellapsedTime=i,this.animation=L.Util.requestAnimFrame((function(){this._motion(t)}),this,!0)}else this.motionStop(!0)},L.Motion.Animate.motionStartAtChunk=function(t,i){return this._map&&!this.animation&&(this.motionOptions.duration||(this.motionOptions.speed?this.motionOptions.duration=L.Motion.Utils.getDuration(this._linePoints,this.motionOptions.speed):this.motionOptions.duration=0),null!==this.__ellapsedTime&&void 0!==this.__ellapsedTime||(this.__ellapsedTime=0),this.setLatLngs(t),this._motion((new Date).getTime()-this.__ellapsedTime-i),this.fire(L.Motion.Event.Started,{layer:this},!1)),this},L.Motion.Polyline=L.Polyline.extend(L.Motion.Animate),L.Motion.Seq=L.Motion.Seq.extend({options:{pane:L.Motion.Animate.options.pane,attribution:L.Motion.Animate.options.attribution},motionStartAtIndex:function(t,i,n){var e=this.getLayers();if(e&&e.length){this.__prepareStart();var o=t;(o>e.length-1||o<0)&&(o=0);for(var a=0;a<o;a++)e[a].setLatLngs(e[a]._linePoints),i&&e[a].fire(L.Motion.Event.Started,{layer:this},!1),n&&e[a].fire(L.Motion.Event.Ended,{layer:this},!1);e[o].motionStart(),this.fire(L.Motion.Event.Started,{layer:this},!1)}return this},motionResume:function(){return this._activeLayer&&(this._activeLayer.animation||this._activeLayer.__ellapsedTime?this._activeLayer.motionResume():this._activeLayer.motionStart(),this.fire(L.Motion.Event.Resumed,{layer:this},!1)),this},motionRewindByMiles:function(t){var i=this._activeLayer;if(i){var n=this.getLayers(),e=n.indexOf(i),o=1609.344*(t||.1),a=i.getLatLngs(),s=L.Motion.Utils.distance(a);if(0===e&&s<o)this.motionRewind(0);else if(s>=o){var r=i.getLatLngs().map((function(t){return L.latLng(t.lat,t.lng)}));if(r&&r.length>=2){for(var h=0,l=-1,m=r.length-2;m>=0;m--){var p=r.slice(m);if((h=L.Motion.Utils.distance(p))>o){l=m;break}}if(-1!==l){var _=r.slice(0,l),g=L.Motion.Utils.getDuration(_,i.motionOptions.speed);this.__stopLayerAtIndex__(e),this.__prepareStart(),i.motionStartAtChunk(_,g),this.fire(L.Motion.Event.Started,{layer:this},!1)}else this.motionRewind(0)}else this.motionRewind(0)}else for(var d=o-s,v=0,f=[],c=e-1;c>=0;c--){var u=n[c].getLatLngs().map((function(t){return L.latLng(t.lat,t.lng)}));if(!(u&&u.length>=2)){this.motionRewind(0);break}h=0,l=-1;for(var M=u.length-2;M>=0;M--){var y=u.slice(M);if((h=L.Motion.Utils.distance(y))+v>d){l=M;break}}if(-1!==l){_=u.slice(0,l),g=L.Motion.Utils.getDuration(_,n[c].motionOptions.speed);this.__stopLayerAtIndex__(e),n[e].setLatLngs([]);for(var O=0;O<f.length;O++)n[f[O]].setLatLngs([]);this.__prepareStart(),n[c].motionStartAtChunk(_,g),this.fire(L.Motion.Event.Started,{layer:this},!1);break}f.push(c),v+=h}}return this},motionRewind:function(t){var i=this._activeLayer;if(i){var n=this.getLayers(),e=n.indexOf(i),o=e-t;if(o<0&&(o=0),o>=0&&n[o]){var a=n[o];this.__stopLayerAtIndex__(e);for(var s=e;s>=o;s--)n[s].setLatLngs([]);a&&(this.__prepareStart(),a.motionStart(),this.fire(L.Motion.Event.Started,{layer:this},!1))}}return this},motionFastForward:function(t){var i=this._activeLayer;if(i){var n=this.getLayers(),e=n.indexOf(i),o=e+t;if(o>n.length-1&&(o=n.length-1),o>=0&&n[o]){var a=n[o];this.__stopLayerAtIndex__(e);for(var s=e;s<=o;s++)n[s].setLatLngs(n[s]._linePoints);a&&(this.__prepareStart(),a.motionStart(),this.fire(L.Motion.Event.Started,{layer:this},!1))}}return this},motionSpeedChange:function(t){var i=this._activeLayer;if(i){var n,e=this.getLayers(),o=e.indexOf(i),a=this._activeLayer.animation,s=this._activeLayer.motionOptions.duration,r=0,h=this._activeLayer.__ellapsedTime;a&&(L.Util.cancelAnimFrame(this._activeLayer.animation),this._activeLayer.animation=null);for(var l=0;l<e.length;l++){var m=L.Motion.Utils.getDuration(e[l]._linePoints,t);e[l].motionSpeed(t),e[l].motionDuration(m),l===o&&(r=m)}n=h*r/s,a?this._activeLayer._motion((new Date).getTime()-n):this._activeLayer.__ellapsedTime=n}return this},__stopLayerAtIndex__:function(t){var i=this.getLayers();i&&i[t]&&(i[t].off(L.Motion.Event.Ended),i[t].motionStop())}}),exports.motion=L.motion,exports.Motion=L.Motion;
